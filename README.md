
# 🎮 AstrBot Galgame 同乐插件 v1.2.0

你是否曾想过和群友们一起在聊天群里玩 Galgame 或视觉小说？这个插件将这个想法变为了现实！

本插件能够捕捉你电脑上指定的游戏窗口画面，通过截图的方式实时“直播”到聊天群里。群里的每一个人都可以通过简单的指令来控制游戏（例如推进对话、进行选择），实现云玩 Galgame 的有趣体验。

## 注意：小心HCG

## ✨ v1.2.0 版本更新说明

*   ✍️ **按钮注册向导**：通过 `/注册按钮` 获取当前画面，涂鸦标记后即可自动识别点击位置，完成后为按钮命名，后续用 `/点 <名称>` 一键点击。
*   ✨ **全新远程模式 (Remote Mode)**：现在，你可以在一台电脑或服务器上运行AstrBot，同时在另一台性能更好的游戏电脑上玩游戏。
*   🔐 **安全连接**：远程模式使用共享密钥（Secret Token）进行双向验证，确保只有你授权的客户端才能连接到插件，保障了连接的私密性和安全性。

## 🚀 核心功能

*   **双重运行模式**：
    *   **本地模式 (Local)**：最简单的模式，AstrBot 和游戏在同一台 Windows 电脑上运行。
    *   **远程模式 (Remote)**：AstrBot 和游戏可以分别在两台不同的电脑上运行，通过网络连接。
*   **实时游戏画面分享**：将指定窗口的画面以图片形式发送到群聊。
*   **多人协作控制**：群内的任何人都可以发送指令来推进游戏。
*   **完整的键盘模拟**：支持模拟几乎所有键盘按键，并为常用按键提供中文别名。
*   **自定义按钮点击**：通过截图标记按钮后保存坐标，后续可快速发送指令模拟鼠标点击。
*   **两种输入模式**：
    *   **`SendInput` (前台高兼容模式)**：兼容性最强，但**需要将游戏窗口置于最前台**。
    *   **`PostMessage` (后台模式)**：理论上可后台操作，但兼容性较差，不推荐。

## ⚙️ 安装与配置

### 1. 插件安装 (在运行AstrBot的电脑上)

1.  将整个 `astrbot_plugin_galplayer` 文件夹放入你的 AstrBot 的 `data/plugins` 目录中。
2.  启动或重启 AstrBot。
3.  进入 AstrBot 的 WebUI，在“插件管理”页面，找到本插件并确保它已启用。

### 2. 模式选择与配置

在插件管理页面点击“管理”，你会看到所有配置项。**最重要的第一步是选择你的运行模式**。

*   **如果你想使用【本地模式】**：
    1.  确保 `mode` 配置项选择 `local`。
    2.  确保你的AstrBot运行在 **Windows** 系统上。
    3.  完成！你可以直接跳转到 [**使用方法**](#-使用方法) 章节。

*   **如果你想使用【远程模式】**：
    1.  在插件配置中，将 `mode` 切换为 `remote`。
    2.  在 `remote_secret_token` 配置项中，填入一个**你自己设定的复杂密码**（例如 `MySuperSecretKey_12345!@#$`），并保存配置。
    3.  接下来，请在你**准备玩游戏**的电脑上，完成以下客户端设置。

### 3. 远程客户端设置 (在你的游戏电脑上)

你需要一个客户端脚本来连接你的AstrBot。

1.  **准备文件**：在你的游戏电脑上，创建一个新文件夹（例如 `gal_client`），然后将插件目录remote文件夹中的 `remote_client.py` 和它专用的 `requirements.txt` 两个文件放进去。
2.  **安装依赖**：在此文件夹中打开命令行/终端，运行 `pip install -r requirements.txt` 来安装客户端所需的库。
3.  **生成配置**：运行一次客户端脚本：`python remote_client.py`。脚本会自动创建一个 `gal_client_config.ini` 文件，然后退出。
4.  **修改配置**：打开 `gal_client_config.ini` 文件：
    *   `ServerURI`: 修改为运行AstrBot服务器的**IP地址**和端口。
    *   `SecretToken`: **必须填入和插件配置中 `remote_secret_token` 完全相同的密码**。
5.  **启动客户端**：保存配置文件后，再次运行 `python remote_client.py`。如果看到“服务器验证成功”的日志，说明你已成功连接！保持这个命令行窗口运行即可。

## 📖 使用方法

### 1. 启动游戏

在你的**游戏电脑**上打开你想要玩的 Galgame。

### 2. 获取窗口标题

仔细查看游戏窗口最上方的标题栏，记下标题的一部分或者全部（越独特越好）。

### 3. 开始游戏

在群聊中，发送开始指令，并将你记下的标题作为参数。

```
/gal start Doki
```

机器人会找到该窗口，发送第一张截图，游戏正式开始！

### 4. 控制游戏

| 指令 / 消息 | 别名 | 功能 |
| :--- | :--- | :--- |
| `g` 或 `gal` | 无 | **最常用的指令**。发送后会模拟按下“快捷推进键”（默认为`enter`），然后发送新截图。 |
| `/gal start <窗口标题>` | `/gal 开始游戏` | 开始一场新游戏。 |
| `/gal stop` | `/gal 停止游戏` | 结束当前正在进行的游戏。 |
| `/gal type <按键名>` | `/gal 输` | 模拟输入一个指定的按键。支持中文和英文。<br>**示例**: `/gal type enter`, `/gal type a`, `/gal type 上` |
| `/gal resend` | `/gal 重发` | 不执行任何按键，仅重新截取并发送一次当前的游戏画面。 |
| `/gal register_button` | `/注册按钮` | 启动按钮注册向导。机器人会发送当前画面，用户涂鸦后自动识别并模拟一次点击。 |
| `/gal click <按钮名称>` | `/点 <按钮名称>` | 使用已注册的按钮名称，模拟鼠标左键点击并返回最新画面。 |
| `/gal help` | `/gal 帮助` | 在聊天中显示此帮助信息。 |

### 5. 注册按钮（可选）

当某个游戏需要频繁点击固定位置时，可以通过 `/注册按钮` 开启向导：

1. 机器人会发送当前画面，请将图片保存下来并使用画笔在按钮区域进行简单涂鸦。
2. 将涂鸦后的图片发回聊天，机器人会自动识别标注区域并模拟一次点击，同时发送点击后的截图供你确认。
3. 回复 **1** 表示点击成功（或 **2** 表示失败重来），成功后再回复按钮名称即可完成注册。
4. 以后可以直接发送 `/点 <按钮名称>` 或 `/gal click <按钮名称>` 来自动点击该位置。

向导会在 1 分钟无操作后自动取消，重新发送 `/注册按钮` 即可再次开始。

### 🎯 涂鸦识别与点击原理

当你在机器人发送的截图上进行涂鸦并重新发回时，插件会执行如下步骤来定位按钮并模拟点击：

1. **色彩突变检测**：将两张图片转换到 HSV 色彩空间，寻找那些相较于原图突然变得非常鲜艳/明亮的像素（典型的涂鸦笔迹）。
2. **去噪聚合**：把这些像素组合成掩膜，并用中值滤波抚平零散噪点，得到稳定的涂鸦区域最小外接矩形。
3. **相对坐标**：计算矩形中心点在整张图中的相对坐标（0.0~1.0），确保不同分辨率/缩放下仍然准确。
4. **鼠标模拟**：在 Windows 环境下通过 `pywin32` 提供的 `win32api`/`win32con`（本地模式）或远程客户端中的同一套 API，将相对坐标换算成屏幕坐标并发送 `WM_LBUTTONDOWN/UP` 消息完成点击。

整个流程不依赖复杂的图像识别算法，只要用画笔稍微涂抹一下按钮区域即可可靠地取到中心点。

## 🔧 详细配置

| 配置项 | 类型 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- |
| **`mode`** | `下拉选择` | `local` | **模式开关**。`local` 表示本地模式，`remote` 表示远程模式。 |
| `remote_server` | `对象` | `...` | 远程模式下服务器的监听地址和端口。通常保持默认。 |
| `remote_secret_token`| `字符串` | `""` | **远程模式连接密钥**。必须与客户端配置文件中的 `SecretToken` 一致。 |
| **`input_method`** | `下拉选择` | `SendInput` | **最重要的配置！** 选择按键的输入模式。<br>- **`SendInput`**: 前台模式，兼容性最强，但游戏窗口必须是当前活动窗口。<br>- **`PostMessage`**: 后台模式，兼容性较差。 |
| `cooldown_seconds` | `浮点数` | `3.0` | 两次指令之间的最小时间间隔（秒），用于防止刷屏。 |
| `screenshot_delay_seconds`| `浮点数` | `1.0` | 按键后等待多久再截图（秒）。如果游戏动画较慢，可以适当调高此值。 |
| `quick_advance_key` | `字符串` | `enter` | 设置 `g` 或 `gal` 这条快捷指令所对应的键盘按键。 |

## ❓ 疑难解答 (FAQ)

**Q: 我对一个游戏使用了所有指令，但它就是没反应！**
**A:** 这是最常见的问题！请进入插件配置页面，将 **`input_method`** 从 `PostMessage` **切换到 `SendInput`**，保存后重试。这能解决绝大多数游戏的兼容性问题，但代价是游戏窗口必须保持在前台。

**Q: 【远程模式】客户端提示 "Connection failed" 或 "连接失败"。**
**A:** 请检查：1. `ServerURI` 中的IP地址是否正确。2. 端口号是否正确（默认为`8765`）。3. 运行AstrBot的服务器的**防火墙**是否允许`8765`端口的入站连接。

**Q: 【远程模式】客户端提示 "Token mismatch" 或 "验证失败"。**
**A:** 这说明插件配置里的 `remote_secret_token` 和客户端 `gal_client_config.ini` 文件里的 `SecretToken` **不一致**。请仔细检查并确保它们完全相同，包括大小写和符号。

**Q: 机器人提示“找不到窗口”。**
**A:** 请确保：1. 游戏已经打开。2. 你在 `/gal start` 指令后输入的窗口标题和游戏窗口上显示的**完全一致**。

**Q: 游戏可以最小化吗？**
**A:** 不可以。无论在哪种模式下，游戏窗口都必须处于打开状态（不能最小化），但可以使用 `PostMessage` 模式让它被其他窗口遮挡。


